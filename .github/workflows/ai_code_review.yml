name: AI Code Review

on: [pull_request]

permissions:
  contents: read
  pull-requests: write

jobs:
  review:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Read Agent Instructions
        id: read_instructions
        run: |
          {
            echo 'content<<EOF'
            cat .github/agents/code_review_agent.md
            echo 'EOF'
          } >> $GITHUB_OUTPUT

      - name: Run AI Review
        uses: actions/github-script@v7
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          INSTRUCTIONS: ${{ steps.read_instructions.outputs.content }}
        with:
          script: |
            const instructions = process.env.INSTRUCTIONS;
            const apiKey = process.env.OPENAI_API_KEY;

            if (!apiKey) {
              core.setFailed("âŒ OPENAI_API_KEY secret is missing.");
              return;
            }

            const consoleLog = (msg) => console.log(`[AI Review] ${msg}`);

            // 1. Fetch Diff
            consoleLog("Fetching PR Diff...");
            const { data: diff } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
              mediaType: { format: "diff" },
            });

            if (diff.length > 30000) {
              consoleLog("Diff too large. Skipping.");
              return; // Don't fail, just skip
            }

            // 2. Call OpenAI (JSON Mode)
            consoleLog("Sending to OpenAI...");
            const response = await fetch('https://api.openai.com/v1/chat/completions', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${apiKey}`
              },
              body: JSON.stringify({
                model: "gpt-4o",
                temperature: 0.2,
                response_format: { type: "json_object" }, // Force JSON output
                messages: [
                  { 
                    role: "system", 
                    content: `You are a strict Senior Software Engineer.
                    
                    YOUR INSTRUCTIONS:
                    ${instructions}
                    
                    TASK:
                    Review the Git Diff. Output a JSON object with two fields:
                    1. "status": Either "APPROVE" (if code is good) or "REQUEST_CHANGES" (if rules are broken or bugs found).
                    2. "comment": A concise markdown review summary.
                    
                    CRITICAL:
                    - If the code violates the "Active Constraints" in instructions, status MUST be "REQUEST_CHANGES".
                    - If there are security flaws, status MUST be "REQUEST_CHANGES".` 
                  },
                  { role: "user", content: diff }
                ]
              })
            });

            const json = await response.json();
            if (json.error) {
              core.setFailed(`OpenAI Error: ${json.error.message}`);
              return;
            }

            // 3. Process Result
            const aiContent = JSON.parse(json.choices[0].message.content);
            const reviewEvent = aiContent.status === "APPROVE" ? "APPROVE" : "REQUEST_CHANGES";

            consoleLog(`AI Verdict: ${reviewEvent}`);

            // 4. Submit Formal Review
            await github.rest.pulls.createReview({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
              body: `### ðŸ¤– AI Agent Verdict: ${aiContent.status}\n\n${aiContent.comment}`,
              event: reviewEvent
            });

            // 5. Optional: Fail the Action itself if changes are requested
            // This ensures the "Status Check" turns red in GitHub
            if (reviewEvent === "REQUEST_CHANGES") {
              core.setFailed("AI Agent requested changes. Please fix violations.");
            }

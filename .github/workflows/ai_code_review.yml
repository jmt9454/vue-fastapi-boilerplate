name: AI Code Review

on: [pull_request]

permissions:
  contents: read
  pull-requests: write

jobs:
  review:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Read Agent Instructions
        id: read_instructions
        run: |
          # Read agents.md and save it to GITHUB_OUTPUT using a delimiter
          # This is the modern, safe way to handle multiline strings in Actions
          {
            echo 'content<<EOF'
            cat agents.md
            echo 'EOF'
          } >> $GITHUB_OUTPUT

      - name: Run AI Review
        uses: actions/github-script@v7
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          INSTRUCTIONS: ${{ steps.read_instructions.outputs.content }}
        with:
          script: |
            // 1. Setup and Safety Checks
            const instructions = process.env.INSTRUCTIONS;
            const apiKey = process.env.OPENAI_API_KEY;

            if (!apiKey) {
              core.setFailed("‚ùå OPENAI_API_KEY secret is missing from GitHub Settings.");
              return;
            }

            // 2. Fetch the Pull Request Diff (The actual code changes)
            // We request the 'diff' format specifically
            console.log("Fetching PR Diff...");
            const { data: diff } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
              mediaType: {
                format: "diff",
              },
            });

            if (diff.length > 30000) {
              console.log("Diff is too large for AI review. Skipping.");
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: "‚ö†Ô∏è **AI Review Skipped:** The changes in this PR are too large to process."
              });
              return;
            }

            // 3. Call OpenAI API
            console.log("Sending to OpenAI...");
            const response = await fetch('https://api.openai.com/v1/chat/completions', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${apiKey}`
              },
              body: JSON.stringify({
                model: "gpt-4o", // Using the latest fast model
                temperature: 0.2, // Keep it strict and analytical
                messages: [
                  { 
                    role: "system", 
                    content: `You are a strict Senior Software Engineer reviewing a Pull Request. 
                    
                    YOUR INSTRUCTIONS:
                    ${instructions}
                    
                    TASK:
                    Review the provided Git Diff. 
                    - Point out violations of the "Active Constraints" in the instructions.
                    - Look for security vulnerabilities.
                    - Suggest specific code improvements.
                    - Be concise and constructive.` 
                  },
                  { role: "user", content: diff }
                ]
              })
            });

            const json = await response.json();

            if (json.error) {
              core.setFailed(`OpenAI API Error: ${json.error.message}`);
              return;
            }

            // 4. Post the Review Comment
            const aiReview = json.choices[0].message.content;

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `### ü§ñ AI Agent Review\n\n${aiReview}`
            });
